# 磁控软体微型机器人的路径跟随控制研究

## A. 绪论

1. 微型机器人的控制按照控制类型不同可以分为运动控制和行为控制两部分
   - 运动控制的着眼点在于整个微型机器人的位置和姿态上，包括路径跟随控制和轨迹跟随控制等
   - 行为控制着眼点在于机器人完成的任务上，包括抓取、推动、释放、变形等。

2. 路径跟随与轨迹跟踪在误差定义上存在本质区别。
3. 微型机器人受扰动影响产生的效果可以分成两个方面
   - 相对于期望路径产生的侧向偏差（与时间无关）
   - 相对于期望的时变轨迹产生时滞误差（与时间有关）

4. 路径跟随任务不受时间约束，更关心移动智能体实际运行路径在一定误差范围内是否趋近于参考路径。
5. **`本文中路径跟随任务需要结合微型机器人位置控制和转向控制来实现`**
6. 本文研究内容：
   - 设计开发了一套操控系统，包括：主控制线程、线圈驱动线程、视觉反馈线程、GUI线程：可以实时监控和虚拟重建微型机器人及周边环境状态。**`可以实现对重磁场的生成与控制，包括恒定、旋转、振荡、锥形、脉冲等磁场，以及用户自定义磁场接口`**
   - 基于视觉伺服的路径跟随控制算法，并实现了3D任意路径的跟随控制
   - 设计了新型具有多种运动模态的水凝胶材质软体薄膜机器人，**`具有磁性头部和功能性薄膜的尾部`**

## B. 磁驱动

1. 运动模型：流体运动的Navier-Stokes公式：
   $$
   (\frac {\rho vL} \eta)\frac{dV}{dt} = -\nabla \rho + \nabla ^2V\\
   Re =\frac {\rho vL} \eta 
   $$
   式中，$\rho$ 是流体密度，$v$ 是运动物体速度，$L$ 是运动物体特征长度，$\eta$ 是流体的动力学粘度， $V$ 是流体速度。

2. **`当前主流的磁驱动系统主要分两大类：电磁线圈系统和机械臂操控永磁系统。`**

   <img src="C:\Users\33931\AppData\Roaming\Typora\typora-user-images\image-20210917140227484.png" alt="磁驱动仿生机器人类型" style="zoom:50%;" />

3. **`两种不受约束进行空间运动：磁性头部附着灵活尾部（A、B），或者实在灵活尾部中镶嵌磁性粒子（C）`**

4. 无尾机器人，依附在边界上运动（D）

5. **`当放置在施加有周期性交变的磁场空间时，磁微型机器人受到外界交变磁场施加的磁力和力矩，从而产生旋转、牵引或振荡运动。`**

6. 对于一个磁性对象，可以用总偶极矩 $M$ [$A \cdot m^{-1}$] 来表示其整个身体的平均磁化强度。

7. 磁性对象在磁通量密度为 $B[T]$  的磁场中受到的磁力 $F_m[N]$ 和扭矩 $\tau _m[N \cdot m]$ 可以表
   $$
   F_m=(M\cdot\nabla)B\\\tau _m= M\cross B
   $$

8. 

---

### 几种常用的磁场：

<img src="C:\Users\33931\AppData\Roaming\Typora\typora-user-images\image-20210917144418249.png" alt="image-20210917144418249" style="zoom:50%;" />

- 垂直振荡磁场 $B$ 定义为磁场方向绕单位向量 $n=[\begin{matrix}n_x&n_y& n_z\end{matrix}]^T$ **振荡**的磁场，且磁场方向被约束在含向量 $n$ 且垂直于 $XY$ 平面的垂直平面内，其振荡振幅为 $\pi$。磁场 $B$ 可以表示为：
  $$
  B(t) = B[|cos(2\pi ft)|n+sin(2\pi ft)u]
  $$
  式中 $B$ 是`亥姆霍兹线圈`中心位置的磁通密度， $u=[\begin{matrix}0&0&1 \end{matrix}]^T$ 是振荡平面上与 $n$ 垂直的单位矢量。

- 水平振荡磁场方向被约束在含向量 $n$ 且平行于 $XY$ 平面的垂直平面内，振荡振幅为$\pi$。磁场 $B$ 可以表示为：
  $$
  B(t) = B[|cos(2\pi ft)|n+sin(2\pi ft)u]
  $$
  式中， $u=[\begin{matrix}-n_y&n_x&0 \end{matrix}]^T$ 是振荡平面上与 $n$ 垂直的单位矢量。

- 旋转磁场为磁场方向绕单位向量 $n=[\begin{matrix}n_x&n_y& n_z\end{matrix}]^T$ **旋转**的磁场。磁场 $B$ 可以表示为：
  $$
  B(t) = B[cos(2\pi ft)u+sin(2\pi ft)v]
  $$
  式中，$u$ 和 $v$ 表示旋转磁场旋转平面上的基向量，它们都垂直于 $n$。

- 锥形磁场定义为以单位向量 $n=[\begin{matrix}n_x&n_y& n_z\end{matrix}]^T$ **为旋转轴的旋转磁场**与磁场方向平行于 $n$ 的恒定磁场的**叠加**。磁场 $B$ 可以表示为：
  $$
  B(t) = B[cos(2\pi ft)u+sin(2\pi ft)v + \gamma n]
  $$
  式中，$u$ 和 $v$ 表示旋转磁场旋转平面上的基向量，它们都垂直于 $n$。**常数** $\gamma$ 是方向平行于 $n$ 的恒定磁场分量的系数。

  ---

## C. 路径跟随

### 机器人制作？

1. 使用方法：基于位置的伺服控制方法（PBVS）。

2. 机器人制作：以医用硅胶聚合物为基质，按一定比例混合磁性颗粒，通过特殊的磁化过程制成**具有特殊磁化剖面的软体薄膜**的亚毫米级磁驱动软体微型机器人。**此时机器人得到了特殊的磁化剖面**

3. 将机器人进行了磁化之后外加旋转磁场使机器人发生了形变->在三维空间中形成了稳定的螺旋型推进结构。

4. 螺旋运动的磁驱动软体微型机器人在低雷诺数环境中，受到的非流体作用力 $F$ 和扭矩 $T$ 与机器人推进速度和角速度的关系可以表示为：
   $$
   \left[\begin{matrix}F\\T \end{matrix}\right] =\left[\begin{matrix}A&B\\B^T&C \end{matrix}\right]\left[\begin{matrix}v_p\\\omega \end{matrix}\right]
   $$
   其中，A、B、C 分别为 $3\cross3$ 矩阵，其中封装了机器人的结构和环境特征。

5. 由于体积小，磁场均匀，由重力和磁力之和给出的非流体施加的力 $F$ 被认为是一种扰动，运动控制器通常要进行校正。

### 运动模型

1. **在不考虑受力过程的运动模型中，微型机器人可以被认为是一个类似于`欠驱动`的水下无人机（AUV）。**

2. 在忽略重力等非流体力造成的侧滑漂移（此时前进方向 $n$ 与旋转中轴方向 $n_p$ 一致），微型机器人的控制输入为前进方向转向角，即俯仰角 $\psi$ 和航向角 $\theta$ ，并且机器人前进方向转向角即为外界旋转中轴方向角。

   <img src="C:\Users\33931\AppData\Roaming\Typora\typora-user-images\image-20210917191852833.png" alt="image-20210917191852833" style="zoom:50%;" />

   机器人运动方程可表示为：
   $$
   \left[
   	\begin{matrix}
       \dot x \\ \dot y \\ \dot z \\ \dot \theta \\ \dot \psi
   	\end{matrix}
   \right]=
   \left[
   	\begin{matrix}
       vcos\psi cos\theta \\ vcos\psi sin\theta \\ vsin\psi \\ \omega_z \\ \omega_y
   	\end{matrix}
   \right]
   $$
   其中，$v$ 为机器人前进速度，$\omega_z$ 和 $\omega_y$ 分别为 $z$ 轴方向和 $y$ 轴方向的旋转角速度。

   该模型有三个自由度，完成空间内五个自由度的运动，为非完整约束系统。

   <img src="D:\Tencent\QQFiles\339312333\FileRecv\MobileFile\IMG_0020(20210917-194735).PNG" alt="IMG_0020(20210917-194735)" style="zoom:25%;" />

### 路径跟随任务

1. 使用关键点序列来描述三维路径，而不是使用参数方程，每个相邻的点连接成一条直线来近似路径行的一个段。
2. 三维任意路径跟随任务可以看作是多个直线字段路径跟随任务的组合，是一个迭代过程。当机器人的位置 $P$ 与当前激活路径子段的终点 $C_{k+1}$ 之间的距离小于所设计的阈值时，激活短的下一段路径被激活。
3. **`闭环控制目标是`**驱动前进速度方向向量 $n$ 与激活段单位向量 $\tau _k$ 对齐，同时还需保证机器人实际运动轨迹在一定误差范围内趋近于期望轨迹。

### 控制器

双闭环控制框架

<img src="C:\Users\33931\AppData\Roaming\Typora\typora-user-images\image-20210917202642140.png" alt="image-20210917202642140" style="zoom:33%;" />

外环导航控制器：

- 外环：获得机器人想要的期望前进速度方向。
- 内环：引导机器人朝着这个方向运动。

### 位姿估计

- 目前广泛采用的方法有：**`基于激光（或声呐）测距的方法`**、**`基于目标特征约束的单目视觉测量方法`**以及**`基于双目立体视觉的测量方法`**。

- 与刚体微型机器人运动相比，软体薄膜微型机器人运动既包含了刚体运动又包含了非刚体运动，因而位姿计算相对复杂。

- 机器人的实际前进速度可以通过减去机器人当前位置坐标 $P$ 和前一个位置坐标 $P_{pre}$ 得到的向量来表示：
  $$
  \left\{
  \begin{array}{}
  P= ^wR_{cs}\  ^{cs}P + ^wT_{cs} \\ 
  v = P - P_{pre}
  \end{array}
  \right.
  $$
  式中，$^wR_{cs}$ 和 $^wT_{cs}$ 分别是从侧相机坐标系 $\{CS\}$ 到世界坐标系 $\{U\}$ 的旋转矩阵和平移矩阵，$^{cs}P$ 表示世界坐标系 $\{U\}$ 中位置点 $P$ 在侧相机坐标系 $\{CS\}$ 上的坐标，可通过一个标定的三维立体视觉系统求得。

- 由于微型机器人在旋转频率已知的均匀旋转磁场中具有周期性旋转运动，测量系统采用**`滑动平均滤波器`**对机器人的位置进行估计以获取机器人在**`像素坐标系`**中的位置，再通过**已标定的双目立体视觉系统内外参数矩阵**即可估算当前 $k$ 时刻微型机器人在世界坐标系中的位置 $P_k$。为了精确估计机器人实时的前进方向，**测量系统采用最小二乘方法**，拟合当前时刻及过去前 $m-1$ 个机器人位置坐标 $\{P_{k-m+1},P_{k-m+2},\dots,P_k\}$，得到向量 $v_k$ 作为当前 $k$ 时刻微型机器人的实时前进方向。

### 控制率

#### 外环

外环输入为期望路径的关键点集合 $\zeta (n)$ 和机器人位置坐标 $P$ ，输出为下一时刻最优的前进方向向量 $n^*$。

状态向量表示为：
$$
q = \left[\begin{matrix} d \\ \Omega_e \end{matrix}\right] = \left[\begin{matrix} D-P \\ F(d_\perp)-F(n) \end{matrix}\right]
$$
其中 $F(\cdot)$ 是世界坐标系坐标到欧拉坐标系的映射函数，例如机器人速度方向 $v=[\begin{matrix}v_x &v_y&v_z \end{matrix}]^T$ 可以转化为由俯仰角和航向角表示的转向角向量表达式：**(将向量转化成角度？)**
$$
F(v) = \Omega = \left[ \begin{matrix} \theta \\ \psi \end{matrix}\right] = \left[ \begin{matrix} arctan\frac{v_y}{v_x}  \\ arctan(\frac{v_z}{\sqrt{v_x^2+v_y^2}}) \end{matrix}\right]
$$
`外环控制器的目的`是输出的前进方向序列能够最小化 $q$， 并使之趋近于 $0$。

**本文的控制方案：输出的最优前进方向向量由两部分组成**
$$
n^* = \frac{||d||}{||d||+M}d_{||}+\frac M{||d||+M}d_\perp
$$
其中，$d_{\perp}$ 和$d_{||}$ 分别是垂直于和平行于距离误差向量 $\vec{DP}$ 的单位向量。前者使得机器人位置趋近于**期望路径**，后者使得机器人前进方向趋近于**期望路径的切向方向**，通过改变控制参量 $M$ 从而调节这两部分所占比重。

**目的是能够让机器人在远离期望路径时优先于趋近期望路径，当靠近期望路径是，时，优先沿着路径方向前进。**

<img src="C:\Users\33931\AppData\Roaming\Typora\typora-user-images\image-20210917215849918.png" alt="image-20210917215849918" style="zoom: 33%;" />

#### 内环

内环转向控制器状态向量表示为：
$$
\Omega_{error} = F(n^*)-F(n)
$$
`内环控制器的目的`是最小化机器人前进方向与外环给定的期望前进方向之间的转向角误差

**使用PI控制器：**
$$
\Omega_{out} = F(v)+K_p\Omega_{error}+K_i\sum\Omega_{error}
$$


## 疑问：

1. B节中线圈系统的具体驱动方式是什么
2. B节中磁场B的公式是如何得来的，不同磁场的B具体的作用在哪
3. B节中的单位向量 $n$ 是哪个方向
4. C节中扭转角 $\phi$ 公式中的 $\tau$ 是什么，是否是磁力矩？文章没有标注，这个公式是怎么来的
5. C节中Euler-Bernoulli方程的左半部分意义是什么？[0 0 1]的作用是？
6. 位姿估计时如何用最小二乘法拟合得到 $v_k$ 的？

